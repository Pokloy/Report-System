<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- GOOGLE FONTS LINKS -->
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;400;500&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,500;1,200&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;1,200&display=swap" rel="stylesheet">
    <!-- ICONS -->
	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<!-- CSS -->
    <link th:href="@{/css/user/editReport.css}" rel="stylesheet"></link>
	<link th:href="@{/css/common.css}" rel="stylesheet"></link>
	
	
	
    <title>Report Details</title>
	</head>
	<body>
	<div th:replace="layout/userheader :: headerAll (imgVal=${profilePhoto})"></div>
	
	<main>
	   <div id="first-div" class="borders">    	
  		  <div id="create-label" th:text="${'Edit Report:' + formattedReportDate}"></div>                          
          <div class="create-report__nav">
		    <a th:if="${origin == null}" th:href="@{/view-dailyReport/{reportDate}(reportDate=${reportWebDto.reportDate})}">
			    <i class="fa fa-long-arrow-left"></i>
			    <span>BACK</span>
			</a>
			
			<a th:unless="${origin == null}" th:href="@{__${origin == 'TOP' ? '/userTop' : origin == 'TOP-VIEW' ? '/view-dailyReport/' + reportWebDto.reportDate + '?cid=TOP' : '/view-dailyReport/' + reportWebDto.reportDate}__}">
			    <i class="fa fa-long-arrow-left"></i>
			    <span>BACK</span>
			</a>
			
			<a th:if="${isFromViewReports == 'true'}" th:href="@{/view-reports?status=0}">
			    <i class="fa fa-long-arrow-left"></i>
			    <span>BACK</span>
			</a>  
		    <a href="/userTop" >
		    	<span>
		    		HOME
		    	</span>
		    	 <i class="fa fa-home w3-tiny"></i>     
		    </a>
		</div>	
      </div>
	    <div class="general-container borders">      
	       <form th:action="@{|/view-dailyReport/edit/confirmation${origin != null ? #strings.concat('?cid=', origin) : ''}|}"   
	        enctype="multipart/form-data" method="post" th:object="${reportWebDto}" id="report-form">
				<div class="grid-container ">
				
	           		<div class=" form-group">	           			
	           				<div class="target" >
	           					<div >Target:</div>
	           					<div  class="error-message scroll" th:errors="*{target}"></div>      
	           				</div>     			
	                    <textarea class="scroll"  id="target" name="target" th:text="*{target}" ></textarea>
	             	</div>
	             	<div class="form-group">	             	
		             		<div class="comments ">
		             			<div>Actual:</div>
		             			<div  class="error-message scroll" th:errors="*{comments}"></div>    
		             		</div>         		
	                     <textarea class="scroll" id="comments" name="comments" th:text="*{comments}" ></textarea>
	             	</div>
	             	
	             	<div class="form-group">
	             		<div class="rating-label borders"> Rating:</div>
						<select class="borders"  id="numberSelect"  name="ratings" th:field="*{ratings}">
						    <option value="1" th:selected="${reportWebDto.ratings == 1}">1</option>
						    <option value="2" th:selected="${reportWebDto.ratings == 2}">2</option>
						    <option value="3" th:selected="${reportWebDto.ratings == 3}">3</option>
						    <option value="4" th:selected="${reportWebDto.ratings == 4}">4</option>
						    <option value="5" th:selected="${reportWebDto.ratings == 5}">5</option>
						</select>
						<div class="custom-file-upload">
						<label for="image" >
		  					<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36" fill="none">
						  	<path d="M35.5 20.5H20.5V35.5H15.5V20.5H0.5V15.5H15.5V0.5H20.5V15.5H35.5V20.5Z" fill="#CCCCCC"/>
							</svg>
		   				 	<input class="form-control" type="file" id="image" th:field="*{images}" accept="image/jpeg, image/png" multiple>				    				
	 					</label>
	 					<p>Add Image</p>	
	             	    </div>
	            	</div>						
	        
		                
				  </div>  
			          <div id="image-container__parent" class="image-grid listOfImages images item4 " >				   			     						
						<div class="image-grid image-container listOfImages  ">     							
			     		  <div th:each="image, iterStat : *{fromConfirm ? encodedImages : encodedImagesOut}" th:if="${#strings.length(image) > 'data:image/jpeg;base64,'.length()}" class="image">
						     <img th:src="'data:' + 'image/jpeg' + ';base64,' + ${image}" data-report="image"/>        
						   </div>				     		    	
	                    </div>
	           	   	</div> 	           	   	           	   
	  			  <div class=" btn-container"> 
	            	<a class="cancel" href="/userTop" >
				    	<span>
				    		CANCEL
				    	</span>    
					</a>             		                           			    	                
	              	<input class="submit" type="submit" value="CONFIRM"> 	              		              	         
	           	  </div>			                     	                    	                     
	              <input type="hidden" name="images" th:value="*{encodedImagesOut}">
	              <input type="hidden" name="reportDate" th:value="*{reportDate}">
	              <input type="hidden" th:field="*{fromConfirm}">   
	              <input type="hidden" name="inputDate" th:value="*{reportDate}">       
	       </form>       
	   	 </div>

	</main>
    <!-- SCRIPT FOR DISPLAYING THE IMAGE -->
    <script >
   
    		let storedFiles = [];
	        const image = document.querySelector("#image");
	       	let imageContainer = document.querySelector(".image-container");
	        const imageContainerParent = document.querySelector("#image-container__parent");
        
         	var allImage = document.querySelectorAll("[data-report='image']");
         	
        
        
        	for(let imagesss of allImage){
        		
	        	const deleteElement = document.createElement('span');
	        	deleteElement.setAttribute('class', 'delete');
	            imagesss.parentElement.appendChild(deleteElement);
	            
	            imagesss.parentElement.addEventListener('mouseover', function() {
	           
	            	deleteElement.style.display = 'inline-block';
	            });
	            
	            imagesss.parentElement.addEventListener('mouseleave', function() {
	            	
	            	
	            	deleteElement.style.display = 'none';
	            });
	            
	            deleteElement.addEventListener('click', function(e) {
	            	
	            	imagesss.parentElement.remove();
	            	
	            	
	            	const imageId = imagesss.src; 
			        // Remove 'data:' + 'image/jpeg' + ';base64,' from imageId
			        const cleanImageId = imageId.replace(/^data:image\/\w+;base64,/, '');
			       	  
	         	   // Create a hidden input element
	         	    const hiddenInput = document.createElement('input');
	         	    hiddenInput.type = 'hidden';
	         	    hiddenInput.name = 'deletedImages';
	         	    hiddenInput.value = cleanImageId;
		         	const parentForm = document.getElementById('report-form');
	         	    parentForm.appendChild(hiddenInput);
	         	    
	         	   const newChildArr = creatingNewArrBasedOnImageContainer(imageContainer.childNodes);
	         	   imageContainerParentChildCheckHandler(newChildArr.length);
	        
	            })
	        }
        
        	image.addEventListener("change", (e) => {
       		
            const files = e.target.files;
            console.log(files);
            if((imageContainer === null || 
           			imageContainer === undefined)
           			&& files.length> 0){
           		const imageContainerClone = document.createElement('div');
           		
           		imageContainerClone.classList.add("image-grid","image-container","listOfImages");
       
           		
           		imageContainer = imageContainerClone;
           		imageContainerParent.appendChild(imageContainerClone);
           	}
            
            for (let i = 0; i < files.length; i++) {
            	const div = document.createElement('div');
            	div.setAttribute('class', 'image');
            	imageContainer.classList.add("image-grid","image-container","listOfImages");
            	imageContainer.appendChild(div);
            	
            
            	const newChildArr = creatingNewArrBasedOnImageContainer(imageContainer.childNodes);
           	   	imageContainerParentChildCheckHandler(newChildArr.length);
            	
                const file = files[i];
                const imageUrl = URL.createObjectURL(file);
                const imageElement = document.createElement("img");          
                imageElement.src = imageUrl;
                imageElement.width = 100;
                imageElement.height = 100;
                imageElement.setAttribute("data-report","image");
                div.appendChild(imageElement);
              
                const deleteElement = document.createElement('span');
                deleteElement.setAttribute('class', 'delete');
        
                div.appendChild(deleteElement);
                      
                div.addEventListener('mouseover', function() {
                	deleteElement.style.display = 'inline-block';
                });
                
                div.addEventListener('mouseleave', function() {
                	deleteElement.style.display = 'none';
                });
                
                deleteElement.addEventListener('click', function() {
                    
                	let nodes = Array.prototype.slice.call(document.getElementsByClassName('image'));
                	
                	let indexOfImg = nodes.indexOf(div);
                
                	const dt = new DataTransfer();
                	
                	const ambot = Array.from(image.files);
                	ambot.splice(indexOfImg, 1);
                	storedFiles.splice(indexOfImg, 1);
                	
                	for (let j = 0; j < ambot.length; j++) {
                		console.log(ambot[j])
                		dt.items.add(ambot[j]);
                	}
            	
                	image.files = dt.files;            	
                	div.remove();
                	
                	const newChildArr = creatingNewArrBasedOnImageContainer(imageContainer?.childNodes);
               	   	imageContainerParentChildCheckHandler(newChildArr.length);
                
                })
            }
        });
        
		image.addEventListener('change', function(e) {
			const files = e.target.files;
			const filesArr = Array.prototype.slice.call(files);
			
			const dt = new DataTransfer();
			
			filesArr.forEach(function(f) {
				storedFiles.push(f);
			});	
			storedFiles.forEach(function(f) {
				dt.items.add(f);
			});
			
		
			image.files = dt.files;
		});    
		
		
		document.addEventListener("DOMContentLoaded",()=>{
			console.log(imageContainer)
			
			const newChildArr = creatingNewArrBasedOnImageContainer(imageContainer?.childNodes);
			
			imageContainerParentChildCheckHandler(newChildArr.length);
			
		})
		
		function imageContainerParentChildCheckHandler(x){
			
	
			if(x ===0){
				imageContainerParent.classList.remove("images");
				imageContainerParent.style.display = "none";
				//inline css
			}else {
				imageContainerParent.classList.add("images");
				imageContainerParent.style.removeProperty("display");
				//remove inline css
			}
			
		}
		
		function creatingNewArrBasedOnImageContainer(childArr) {
		
			let newChildArr = [];
        	
			childArr?.forEach(val=>{
        		if(val?.nodeName.toLowerCase() === "div"){
        			return newChildArr.push(val);
        		}
        	});

			return newChildArr;
		}
    </script>
    
   
</body>
</html>
